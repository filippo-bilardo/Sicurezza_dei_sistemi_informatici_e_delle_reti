# Capitolo 31 - Introduzione al Malware

> **Corso**: Sistemi e Reti 3  
> **Parte**: 9 - Malware e Minacce  
> **Autore**: Prof. Filippo Bilardo

---

## Cos'√® il Malware?

**Malware** = Malicious Software

Software progettato per:
- Danneggiare sistemi
- Rubare dati
- Prendere controllo
- Spiare utenti

## Categorie Principali

### 1. Virus

Si replica attaccandosi a file eseguibili.

```
File pulito ‚Üí Virus si copia ‚Üí File infetto ‚Üí Esegue payload
```

### 2. Worm

Si auto-replica e diffonde in rete **senza** file host.

**Esempio storico**: WannaCry (2017)
- Exploit EternalBlue (Windows SMB)
- 200.000+ computer infetti
- Ransomware

### 3. Trojan

Sembra legittimo ma contiene codice malevolo.

```
App apparentemente utile ‚Üí Backdoor nascosta ‚Üí Accesso remoto
```

### 4. Ransomware

Cifra file e richiede riscatto.

**Processo**:
```
1. Infezione ‚Üí 2. Cifratura AES/RSA ‚Üí 3. Richiesta Bitcoin ‚Üí 4. Chiave decifrazione (forse)
```

### 5. Spyware

Raccoglie informazioni senza consenso:
- Keylogger
- Screen capture
- Tracking web

### 6. Rootkit

Si nasconde nel sistema a livello kernel:
- Invisibile ad antivirus
- Controllo completo sistema
- Difficile da rimuovere

### 7. Adware

Visualizza pubblicit√† indesiderata:
- Fastidioso ma meno pericoloso
- Pu√≤ tracciare comportamento

## Vettori di Infezione

### 1. Email Phishing

```
Email fasulla ‚Üí Allegato .doc con macro ‚Üí Download malware
```

### 2. Drive-by Download

Visita sito compromesso ‚Üí Exploit browser ‚Üí Infezione

### 3. USB/Dispositivi

```
USB infetta ‚Üí AutoRun ‚Üí Esecuzione malware
```

### 4. Software Craccato

App pirata ‚Üí Trojan incluso ‚Üí Installazione

### 5. Vulnerabilit√† Software

```
Zero-day exploit ‚Üí RCE ‚Üí Malware install
```

## Analisi Malware

### Analisi Statica

Esaminare codice **senza** eseguirlo:

```bash
# Hash del file
sha256sum malware.exe

# Stringhe leggibili
strings malware.exe | grep -i "http"

# Analisi PE header (Windows)
readpe malware.exe

# Ricerca su VirusTotal
# https://www.virustotal.com
```

### Analisi Dinamica

Eseguire in ambiente isolato (sandbox):

```python
import os
import subprocess
import hashlib

def analyze_file(filepath):
    """Analisi base di un file sospetto"""
    
    # 1. Calcola hash
    with open(filepath, 'rb') as f:
        file_hash = hashlib.sha256(f.read()).hexdigest()
    
    print(f"SHA-256: {file_hash}")
    
    # 2. Dimensione
    size = os.path.getsize(filepath)
    print(f"Dimensione: {size} byte")
    
    # 3. Stringhe sospette
    result = subprocess.run(['strings', filepath], 
                          capture_output=True, text=True)
    
    suspicious = ['http://', 'cmd.exe', 'powershell', 'bitcoin']
    for line in result.stdout.split('\n'):
        for pattern in suspicious:
            if pattern.lower() in line.lower():
                print(f"‚ö†Ô∏è  Trovato: {line.strip()}")

# Uso (in ambiente isolato!)
# analyze_file("suspicious.exe")
```

## Indicatori di Compromissione (IOC)

### Hash Files

```python
import hashlib

def get_file_hashes(filepath):
    """Calcola hash multipli per IOC"""
    with open(filepath, 'rb') as f:
        data = f.read()
    
    return {
        'MD5': hashlib.md5(data).hexdigest(),
        'SHA-1': hashlib.sha1(data).hexdigest(),
        'SHA-256': hashlib.sha256(data).hexdigest()
    }

# hashes = get_file_hashes("malware.bin")
```

### Traffico di Rete

```
- IP/Domini C&C (Command and Control)
- User-Agent anomali
- Porte non standard
- Traffico cifrato sospetto
```

### Modifiche Sistema

```
- Chiavi registro Windows modificate
- File in cartelle temporanee
- Processi sconosciuti
- Connessioni rete inaspettate
```

## Protezione

### 1. Prevenzione

```bash
# Aggiornamenti sistema
sudo apt update && sudo apt upgrade

# Antivirus
sudo apt install clamav
sudo freshclam  # Aggiorna definizioni
clamscan -r /home/user  # Scansione
```

### 2. Rilevamento

```python
import psutil
import socket

def monitor_suspicious_connections():
    """Monitora connessioni di rete sospette"""
    
    suspicious_ports = [4444, 5555, 6666, 31337]  # Porte comuni malware
    
    connections = psutil.net_connections(kind='inet')
    
    for conn in connections:
        if conn.status == 'ESTABLISHED':
            if conn.raddr and conn.raddr.port in suspicious_ports:
                print(f"‚ö†Ô∏è  Connessione sospetta: {conn.raddr.ip}:{conn.raddr.port}")

# Esegui monitoraggio
# monitor_suspicious_connections()
```

### 3. Risposta

```
1. Isola sistema infetto dalla rete
2. Identifica malware (hash, comportamento)
3. Rimuovi (antivirus o reinstallazione)
4. Analizza come √® entrato
5. Ripristina da backup pulito
6. Cambia password
```

## Sandbox per Test

```bash
# Docker container isolato
docker run -it --rm --network none ubuntu:latest bash

# Firejail (Linux)
firejail --net=none --private ./suspicious_program

# VirtualBox snapshot
# Crea snapshot prima di test ‚Üí Ripristina dopo
```

## YARA Rules

Per rilevamento pattern malware:

```yara
rule Ransomware_Wannacry
{
    meta:
        description = "Detect WannaCry ransomware"
        author = "Security Team"
    
    strings:
        $s1 = "WNcry@" ascii
        $s2 = ".WNCRYT" ascii
        $s3 = "tasksche.exe" ascii
        $s4 = "@WanaDecryptor@" ascii
    
    condition:
        3 of them
}
```

## Best Practices

### ‚úÖ Difesa

1. **Aggiorna sempre** OS e software
2. **Backup** regolari (offline)
3. **Antivirus** aggiornato
4. **Firewall** attivo
5. **Non aprire** allegati sospetti
6. **Verifica** mittente email
7. **HTTPS** obbligatorio
8. **Password manager**
9. **2FA** ovunque possibile
10. **Formazione** utenti

### ‚ùå Evita

1. Software pirata
2. Siti non sicuri
3. USB sconosciuti
4. Privilegi admin non necessari
5. Click su link sospetti

---

## üîó Collegamenti

- **Successivo**: [Capitolo 32 - Ransomware](32_ransomware.md)
- **Indice**: [Torna all'indice](../00_INDICE.md)

---

## üìö Riferimenti

- MITRE ATT&CK: https://attack.mitre.org
- VirusTotal: https://www.virustotal.com
- ANY.RUN: https://any.run (sandbox online)

**Nota**: Analizzare malware richiede competenze avanzate e ambiente isolato. Mai eseguire su sistema principale!
